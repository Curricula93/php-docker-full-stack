version: '3'
services:
  db:
    image: mysql:latest
    environment:
      MYSQL_DATABASE: php_docker
      MYSQL_USER: php_docker
      MYSQL_PASSWORD: password
      MYSQL_ALLOW_EMPTY_PASSWORD: '0'
    volumes:
      - mysql_data:/var/lib/mysql
    restart: unless-stopped

  www:
    image: php:apache
    volumes:
      - ./:/var/www/html
    depends_on:
      - db
    restart: unless-stopped
    environment:
      APACHE_RUN_USER: www-data
      APACHE_RUN_GROUP: www-data
    command: >
      bash -c "
        docker-php-ext-install mysqli &&
        chown -R www-data:www-data /var/www/html &&
        chmod -R 755 /var/www/html &&
        a2enmod rewrite &&
        echo 'display_errors = On' >> /usr/local/etc/php/php.ini &&
        echo 'error_reporting = E_ALL' >> /usr/local/etc/php/php.ini &&
        echo 'log_errors = On' >> /usr/local/etc/php/php.ini &&
        echo 'error_log = /var/log/php_errors.log' >> /usr/local/etc/php/php.ini &&
        echo '<VirtualHost *:80>
                DocumentRoot /var/www/html
                <Directory /var/www/html>
                    Options Indexes FollowSymLinks
                    AllowOverride All
                    Require all granted
                    DirectoryIndex index.php
                </Directory>
                ErrorLog ${APACHE_LOG_DIR}/error.log
                CustomLog ${APACHE_LOG_DIR}/access.log combined
              </VirtualHost>' > /etc/apache2/sites-available/000-default.conf &&
        apache2-foreground
      "

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    environment:
      PMA_HOST: db
      PMA_PORT: '3306'
    depends_on:
      - db
    restart: unless-stopped

volumes:
  mysql_data:
